upstream backend {
    server web:8080;
}

upstream frontend {
    server client:80;
}

server {
    listen 80;

    #
    # Redirect /api -> /api/
    #
    location = /api {
        return 301 /api/;
    }

    #
    # API (NO path stripping!)
    # /api/auth/login  ->  web:8080/api/auth/login
    #
    location ^~ /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    #
    # Optional: Swagger (if enabled in backend)
    # https://team-j.atd.avans.nl/api/swagger/
    #
    location ^~ /api/swagger/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    #
    # Frontend (Vue)
    #
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    #
    # Cache static assets (frontend only)
    #
    location ~* ^/(?!api/)(?!swagger/).*\.(?:css|js|jpg|jpeg|gif|png|ico|svg|woff2?)$ {
        proxy_pass http://frontend;
        expires 1y;
        add_header Cache-Control "public";
    }
}
